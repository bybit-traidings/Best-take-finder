<html>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
<body style="margin: 0; min-height: 100vh; background: #363636; font-family: Poppins, sans-serif;">
    <div style="display: flex;">
        <div style="width: 60vw; max-height: 672;">
            <div id="chart" style="display: flex; align-items: end; justify-content: space-around; height: 600px; background: #000; overflow: hidden;"></div>
            <div id="chart2" style="display: flex; align-items: center; justify-content: space-around; height: 60px; background: #000; margin-top: 4px; overflow: hidden;"></div>
            <div id="chart3" style="display: flex; align-items: center; justify-content: space-around; height: 12px; position:relative; top: -36px; color: white; overflow: hidden;"></div>
        </div>

        <div style="width: 35vw; color: rgb(227, 227, 227); padding: 1rem 3rem; line-height: 1.3rem; max-height: 657; overflow-y: auto;">
            <h2>Здесь можно расчитать наилучшее значение profit %</h2>
            <p>Заполните все поля:</p>
            <h3>diaposone</h3>
            <input type="text" name="diaposone" id="diaposone" value="3">
            <p>за сколько свечей сделка должна быть закрыта</p>
            <h3>risk</h3>
            <input type="text" name="risk" id="risk" value="0.5">
            <p>Число от -1 до 1. Где -0.5 очень бережливо, 0 нормально, 0.5 умеренный риск, 1 рисково.
                *Если значение вне  этого диапозона результат не будет отражать реальность</p>
            <h3>history</h3>
            <p>
                Загрузите сюда историю в виде строки (Её можно получить скопировав данные из Exel таблици, предварительно скачав на Trading-Wiue) 
                <br><input type="file" id="csvFile" accept=".csv" style="margin-top: 1rem;">
            </p>
            <textarea style="width: 100%;" type="text" name="history" id="history" rows="6" placeholder="Вставьте"></textarea>
            <div style="width: 100%;">
                <button onclick="go()" type="button" style="width: 17rem; line-height: 2rem; margin: 1rem auto; background: #000; border-radius: 1rem; color: aliceblue;">GO!</button>
            </div>
        </div>
    </div>
    <div style="color: aliceblue; text-align: center;">
        <h1>Result</h1>
        <h2 id="result"></h2>
    </div>
</body>
<script>
    const chart = document.getElementById('chart');
    const chart2 = document.getElementById('chart2');
    const chart3 = document.getElementById('chart3');
    const result = document.getElementById('result');
    
    function go() {

        chart.innerHTML = '';        
        chart2.innerHTML = '';
        chart3.innerHTML = '';
        result.innerHTML = '';


        try {
            const diaposone = +document.getElementById('diaposone').value;
            const risk = +document.getElementById('risk').value;
            const history = document.getElementById('history').value;

            if(isNaN(diaposone)) throw Error('nanD');
            if(isNaN(risk)) throw Error('nanR');
            
            const charts = getChart(history||null, +document.getElementById('risk').value, diaposone);

            const favorite = [...charts].sort((a,b)=>b.res-a.res)[0];
            let res = {proc: 0, i: 0};
    
            charts.forEach((c, i) => {
                const column = document.createElement('div');
                const risk = document.createElement('div');
                column.appendChild(risk)
                column.style.cssText = `width: ${window.innerWidth*0.6/(charts.length*1.25)}px; height: ${c.profit*(500/Math.max(...charts.map(c => c.profit)))}px; background: #34c28c;`;
                risk.style.cssText = `width: ${window.innerWidth*0.6/(charts.length*1.25)}px; height: ${c.risk*100}%; background: #d95d5d;`;
                chart.appendChild(column);
    
                const column2 = document.createElement('div');
                column2.style.cssText = `width: ${window.innerWidth*0.6/(charts.length)}px; height: ${c.res*(40/Math.max(...charts.map(c => c.res)))}px; background: ${favorite.res === c.res?'rgb(172, 0, 214)':'rgb(31, 87, 91)'}; `;
                if(favorite.res === c.res) res = {...c, i};
                if(i&&i%Math.ceil(charts.length/18)==0) {
                    const proc = document.createElement('p');
                    proc.innerText = `${(c.proc*100).toFixed(1)}%`
                    chart3.appendChild(proc)
                }
                chart2.appendChild(column2)
            })
    
            result.innerText = history&&history!=='Вставьте'?
            ` Процент take показавший себя наилучшим образом - [  ${(res.proc*100).toFixed(2)}% - ${(charts[res.i+1].proc*100).toFixed(2)}%  ] 
                при этом сумарный профит за весь период составит от - ${(charts.filter(c=>c.proc>res.proc).reduce((a,c)=> a+c.proc,0)*100).toFixed(2)}%
            `:`ВНИМАНИЕ! этот график лишь демонстрация, заполните поля реальными данными! 
                Процент take показавший себя наилучшим образом - [  ${(res.proc*100).toFixed(2)}% - ${(charts[res.i+1].proc*100).toFixed(2)}%  ] \n
            `
            
        } catch (error) {
            const errors = {
                nanD: 'diaposone field must be a number.',
                nanR: 'risk field must be a number.'
            }
            result.innerText = `Error: - ${errors[error.message]||'History data is incorect'}
            `
        }
    }



    function getChart(history, risk, diaposone) {

        const hh = history? history
                .split('\n')
                .map(l => (([time,open,high,low,close,Buy,Sell])=>({time,open,high,low,close,Buy,Sell}))(l.split(',')))
            : []

            console.log(hh);

        const signals = history? 
                hh
                .map((h,i) => !!+h.Buy||!!+h.Sell? [{type: !!+h.Buy? 'b':'s' ,...h}, ...hh.slice(i+1,i+diaposone)]:'')
                .filter(h => !!h)
                .map(s =>  ({
                    close: +s[0].close,
                    proc:(Math.max(...s.map(it=>s[0].type === 'b'? it.high : -it.low))/s[0].close)+(s[0].type === 'b'?-1:1)
                }))
            : 
            new Array(80).fill('')
                .map(_=>({ close: 34+(10*Math.random()-5), proc: (Math.random()/2) }))
                .concat(new Array(9).fill('')
                .map(_=>({ close: 34+(10*Math.random()-5), proc: (Math.random()*5) })))

        signals.sort((a,b) => a.proc-b.proc);


        let chart = signals
            .map((s,i)=> ({...s, profit: s.proc*(signals.length-i)}))
            .map((s,i)=> ({...s, 
                risk:  Math.sqrt(1/(signals.length-i)),
                res: s.profit * (signals.length-(i/((risk+1)||0.01)))/(signals.length)
            }));

        return chart

    }

    document.getElementById('csvFile').addEventListener('change', loadFile, false);
    function loadFile(event){
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function(event) {
            const contents = event.target.result;
            document.getElementById('history').value = contents;
            setTimeout(go,10);
        };

        reader.readAsText(file);
    }
</script>
</html>
